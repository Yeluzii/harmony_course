interface Todo {
  id: number;
  title: string;
  completed: boolean;
  priority: 'low' | 'medium' | 'high';
}

interface TodoStats {
  total: number;
  completed: number;
  active: number;
}

@Entry
@Component
struct DataDrivenUIPage {
  @State title: string = ''

  aboutToAppear() {
    let params = this.getUIContext().getRouter().getParams() as Record<string, Object>
    if (params) {
      this.title = params['title'] as string
    }
  }

  @State todoList: Todo[] = [
    {
      id: 1,
      title: 'å®ŒæˆHarmonyOSä½œä¸š',
      completed: false,
      priority: 'high'
    },
    {
      id: 2,
      title: 'å‡†å¤‡æœŸæœ«è€ƒè¯•',
      completed: false,
      priority: 'medium'
    },
    {
      id: 3,
      title: 'å‚åŠ ç¤¾å›¢æ´»åŠ¨',
      completed: true,
      priority: 'low'
    }
  ];
  @State newTodoTitle: string = '';
  @State filter: 'all' | 'active' | 'completed' = 'all';

  // è·å–è¿‡æ»¤åçš„å¾…åŠäº‹é¡¹
  getFilteredTodos(): Todo[] {
    switch (this.filter) {
      case 'active':
        return this.todoList.filter((todo: Todo) => !todo.completed);
      case 'completed':
        return this.todoList.filter((todo: Todo) => todo.completed);
      default:
        return this.todoList;
    }
  }

  // è·å–ç»Ÿè®¡ä¿¡æ¯
  getStats(): TodoStats {
    return {
      total: this.todoList.length,
      completed: this.todoList.filter((todo: Todo) => todo.completed).length,
      active: this.todoList.filter((todo: Todo) => !todo.completed).length
    } as TodoStats;
  }

  // æ·»åŠ å¾…åŠäº‹é¡¹
  addTodo() {
    if (this.newTodoTitle.trim()) {
      const newId = Math.max(...this.todoList.map((todo: Todo) => todo.id), 0) + 1;
      this.todoList.push({
        id: newId,
        title: this.newTodoTitle.trim(),
        completed: false,
        priority: 'medium'
      });
      this.newTodoTitle = '';
    }
  }

  // åˆ‡æ¢å®ŒæˆçŠ¶æ€
  toggleTodo(id: number) {
    const index = this.todoList.findIndex(todo => todo.id === id);
    if (index !== -1) {
      this.todoList[index].completed = !this.todoList[index].completed;
    }
  }

  // åˆ é™¤å¾…åŠäº‹é¡¹
  deleteTodo(id: number) {
    const index = this.todoList.findIndex(todo => todo.id === id);
    if (index !== -1) {
      this.todoList.splice(index, 1);
    }
  }

  build() {
    Navigation() {
      Column({ space: 20 }) {
        Text('æ™ºèƒ½å¾…åŠæ¸…å•')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)

        // ç»Ÿè®¡ä¿¡æ¯
        Row({ space: 20 }) {
          Text(`æ€»è®¡ï¼š${this.getStats().total}`)
            .fontSize(14)
            .fontColor('#666666')

          Text(`å·²å®Œæˆï¼š${this.getStats().completed}`)
            .fontSize(14)
            .fontColor(Color.Green)

          Text(`è¿›è¡Œä¸­ï¼š${this.getStats().active}`)
            .fontSize(14)
            .fontColor(Color.Orange)
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
        .padding(15)
        .backgroundColor('#F8F9FA')
        .borderRadius(8)

        // æ·»åŠ æ–°å¾…åŠ
        Row({ space: 10 }) {
          TextInput({ placeholder: 'æ·»åŠ æ–°çš„å¾…åŠäº‹é¡¹...', text: this.newTodoTitle })
            .layoutWeight(3)
            .onChange((value: string) => {
              this.newTodoTitle = value;
            })
            .onSubmit(() => {
              this.addTodo();
            })

          Button('æ·»åŠ ')
            .layoutWeight(1)
            .backgroundColor(Color.Blue)
            .enabled(this.newTodoTitle.trim() !== '')
            .onClick(() => {
              this.addTodo();
            })
        }
        .width('100%')

        // è¿‡æ»¤å™¨
        Row({ space: 10 }) {
          Button('å…¨éƒ¨')
            .fontSize(12)
            .backgroundColor(this.filter === 'all' ? Color.Blue : Color.Gray)
            .onClick(() => {
              this.filter = 'all';
            })

          Button('è¿›è¡Œä¸­')
            .fontSize(12)
            .backgroundColor(this.filter === 'active' ? Color.Orange : Color.Gray)
            .onClick(() => {
              this.filter = 'active';
            })

          Button('å·²å®Œæˆ')
            .fontSize(12)
            .backgroundColor(this.filter === 'completed' ? Color.Green : Color.Gray)
            .onClick(() => {
              this.filter = 'completed';
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)

        // å¾…åŠäº‹é¡¹åˆ—è¡¨
        List({ space: 8 }) {
          ForEach(this.getFilteredTodos(), (todo: Todo) => {
            ListItem() {
              Row({ space: 15 }) {
                Button() {
                  Text(todo.completed ? 'âœ“' : '')
                    .fontSize(12)
                    .fontColor(Color.White)
                }
                .width(30)
                .height(30)
                .backgroundColor(todo.completed ? Color.Green : Color.Gray)
                .borderRadius(15)
                .onClick(() => {
                  this.toggleTodo(todo.id);
                })

                Column({ space: 5 }) {
                  Text(todo.title)
                    .fontSize(16)
                    .fontColor(todo.completed ? '#999999' : '#333333')
                    .decoration({
                      type: todo.completed ? TextDecorationType.LineThrough : TextDecorationType.None
                    })

                  Text(`ä¼˜å…ˆçº§ï¼š${todo.priority}`)
                    .fontSize(12)
                    .fontColor(
                      todo.priority === 'high' ? Color.Red :
                        todo.priority === 'medium' ? Color.Orange : Color.Green
                    )
                }
                .flexGrow(1)
                .alignItems(HorizontalAlign.Start)

                Button('åˆ é™¤')
                  .fontSize(12)
                  .backgroundColor(Color.Red)
                  .fontColor(Color.White)
                  .height(30)
                  .onClick(() => {
                    this.deleteTodo(todo.id);
                  })
              }
              .width('100%')
              .padding(15)
              .backgroundColor(Color.White)
              .borderRadius(8)
              .opacity(todo.completed ? 0.7 : 1.0)
            }
          })
        }
        .width('100%')
        .layoutWeight(1)

        // ç©ºçŠ¶æ€æ˜¾ç¤º
        if (this.getFilteredTodos().length === 0) {
          Column({ space: 10 }) {
            Text('ğŸ“')
              .fontSize(48)
              .opacity(0.5)

            Text(
              this.filter === 'all' ? 'æš‚æ— å¾…åŠäº‹é¡¹' :
                this.filter === 'active' ? 'æš‚æ— è¿›è¡Œä¸­çš„äº‹é¡¹' :
                  'æš‚æ— å·²å®Œæˆçš„äº‹é¡¹'
            )
              .fontSize(16)
              .fontColor('#999999')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .padding(20)
      .backgroundColor('#F5F5F5')
    }
    .title(this.title)
    .titleMode(NavigationTitleMode.Mini)
    .hideBackButton(false)
    .navBarWidth('100%')
    .navBarPosition(NavBarPosition.Start)
  }
}