interface ComplexGrade {
  subject: string;
  score: number;
}

interface ComplexStudent {
  name: string;
  age: number;
  grades: Array<ComplexGrade>;
}

@Entry
@Component
struct StarContentPage01 {
  @State title: string = ''

  aboutToAppear() {
    let params = this.getUIContext().getRouter().getParams() as Record<string, Object>
    if (params) {
      this.title = params['title'] as string
    }
  }

  @State student: ComplexStudent = {
    name: 'å¼ åŒå­¦',
    age: 20,
    grades: [
      { subject: 'HarmonyOSå¼€å‘', score: 85 },
      { subject: 'æ•°æ®ç»“æž„', score: 92 },
      { subject: 'è®¡ç®—æœºç½‘ç»œ', score: 78 }
    ]
  };
  @State newSubject: string = '';
  @State newScore: number = 0;

  // è®¡ç®—å¹³å‡åˆ†
  getAverageScore(): number {
    if (this.student.grades.length === 0) {
      return 0;
    }
    const total = this.student.grades.reduce((sum: number, grade: ComplexGrade) => sum + grade.score, 0);
    return Math.round(total / this.student.grades.length);
  }

  // æ·»åŠ æˆç»©
  addGrade() {
    if (this.newSubject && this.newScore > 0 && this.newScore <= 100) {
      // åˆ›å»ºæ–°çš„gradesæ•°ç»„
      const newGrades: Array<ComplexGrade> = [];
      for (let i = 0; i < this.student.grades.length; i++) {
        newGrades.push(this.student.grades[i]);
      }
      newGrades.push({
        subject: this.newSubject,
        score: this.newScore
      });

      // åˆ›å»ºæ–°çš„studentå¯¹è±¡æ¥è§¦å‘çŠ¶æ€æ›´æ–°
      this.student = {
        name: this.student.name,
        age: this.student.age,
        grades: newGrades
      };
      this.newSubject = '';
      this.newScore = 0;
    }
  }

  // åˆ é™¤æˆç»©
  removeGrade(index: number) {
    // åˆ›å»ºæ–°çš„gradesæ•°ç»„
    const newGrades: Array<ComplexGrade> = [];
    for (let i = 0; i < this.student.grades.length; i++) {
      if (i !== index) {
        newGrades.push(this.student.grades[i]);
      }
    }

    // åˆ›å»ºæ–°çš„studentå¯¹è±¡æ¥è§¦å‘çŠ¶æ€æ›´æ–°
    this.student = {
      name: this.student.name,
      age: this.student.age,
      grades: newGrades
    };
  }

  build() {
    Navigation() {
      Column({ space: 16 }) {
        // å­¦ç”Ÿä¿¡æ¯
        Row({ space: 15 }) {
          Text('ðŸ‘¨â€ðŸŽ“')
            .fontSize(32)

          Column({ space: 5 }) {
            Text(this.student.name)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)

            Text(`å¹´é¾„ï¼š${this.student.age}å²`)
              .fontSize(14)
              .fontColor(Color.Gray)

            Text(`å¹³å‡åˆ†ï¼š${this.getAverageScore()}åˆ†`)
              .fontSize(16)
              .fontColor(this.getAverageScore() >= 85 ? Color.Green : Color.Orange)
              .fontWeight(FontWeight.Bold)
          }
          .alignItems(HorizontalAlign.Start)
          .flexGrow(1)
        }
        .width('100%')
        .padding(15)
        .backgroundColor(Color.White)
        .borderRadius(12)

        // æˆç»©åˆ—è¡¨
        Text('è¯¾ç¨‹æˆç»©')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .alignSelf(ItemAlign.Start)

        Column({ space: 10 }) {
          ForEach(this.student.grades, (grade: ComplexGrade, index) => {
            Row({ space: 15 }) {
              Text(grade.subject)
                .fontSize(14)
                .flexGrow(1)

              Text(`${grade.score}åˆ†`)
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor(grade.score >= 85 ? Color.Green : grade.score >= 70 ? Color.Orange : Color.Red)

              Button('åˆ é™¤')
                .fontSize(12)
                .backgroundColor(Color.Red)
                .fontColor(Color.White)
                .height(30)
                .onClick(() => {
                  this.removeGrade(index);
                })
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#F8F9FA')
            .borderRadius(8)
          })
        }

        // æ·»åŠ æˆç»©
        Text('æ·»åŠ æˆç»©')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .alignSelf(ItemAlign.Start)

        Column({ space: 15 }) {
          Row({ space: 10 }) {
            Text('è¯¾ç¨‹ï¼š')
              .fontSize(14)

            TextInput({ placeholder: 'è¯¾ç¨‹åç§°', text: this.newSubject })
              .height(40)
              .layoutWeight(1)
              .onChange((value: string) => {
                this.newSubject = value;
              })
          }

          Row({ space: 10 }) {
            Text('åˆ†æ•°ï¼š')
              .fontSize(14)

            TextInput({ placeholder: '0-100', text: this.newScore === 0 ? '' : this.newScore.toString() })
              .type(InputType.Number)
              .height(40)
              .layoutWeight(1)
              .onChange((value: string) => {
                const score = parseInt(value);
                this.newScore = isNaN(score) ? 0 : score;
              })
          }

          Button('æ·»åŠ ')
            .backgroundColor(Color.Blue)
            .padding({
              left: 20,
              right: 20,
              top: 10,
              bottom: 10
            })
            .enabled(this.newSubject !== '' && this.newScore > 0 && this.newScore <= 100)
            .onClick(() => {
              this.addGrade();
            })
        }
        .width('100%')
        .padding(10)
      }
      .padding(16)
    }
    .title(this.title)
    .titleMode(NavigationTitleMode.Mini)
    .hideBackButton(false)
    .navBarWidth('100%')
    .navBarPosition(NavBarPosition.Start)
  }
}